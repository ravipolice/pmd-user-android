<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMD Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f4f6f8; }
    header { background:#1f2937; color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    nav { background:#111827; color:#fff; padding:8px; display:flex; gap:8px; }
    nav button { background:#374151; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:6px; }
    nav button.active { background:#2563eb; }
    main { padding:16px; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.06); margin-bottom:16px; }
    .row { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .row-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    label { font-size:12px; color:#374151; font-weight:500; }
    input, select { width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db; box-sizing:border-box; }
    button.primary { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:500; }
    button.primary:hover { background:#1d4ed8; }
    button.primary:disabled { background:#9ca3af; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:13px; text-align:left; }
    th { background:#f9fafb; color:#374151; font-weight:600; }
    .hidden { display:none; }
    .error { color:#dc2626; font-size:12px; margin-top:4px; }
    .success { color:#16a34a; font-size:12px; margin-top:4px; }
    .loading { opacity:0.6; pointer-events:none; }
  </style>
</head>
<body>
  <header>
    <div><strong>PMD Admin Panel</strong></div>
    <div>
      <span id="userEmail" class="hidden" style="margin-right:12px; font-size:14px;"></span>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </header>

  <nav id="tabs" class="hidden">
    <button data-tab="employees" class="active">Employees</button>
    <button data-tab="officers">Officers</button>
    <button data-tab="masters">Districts & Stations</button>
  </nav>

  <main>
    <section id="employees" class="card">
      <h3>Add Employee</h3>
      <div class="row">
        <div><label>KGID *</label><input id="e_kgid" required /></div>
        <div><label>Name *</label><input id="e_name" required /></div>
        <div><label>Mobile *</label><input id="e_mobile" type="tel" required /></div>
        <div><label>Designation</label><input id="e_designation" /></div>
        <div><label>District *</label><select id="e_district" required><option value="">Loading...</option></select></div>
        <div><label>Station *</label><select id="e_station" required><option value="">Select District First</option></select></div>
      </div>
      <div id="e_error" class="error hidden"></div>
      <div id="e_success" class="success hidden"></div>
      <br />
      <button class="primary" id="e_submit" onclick="addEmployee()">Save Employee</button>
    </section>

    <section id="officers" class="card hidden">
      <h3>Add Officer</h3>
      <div class="row">
        <div><label>Rank *</label><input id="o_rank" required /></div>
        <div><label>Name *</label><input id="o_name" required /></div>
        <div><label>Mobile *</label><input id="o_mobile" type="tel" required /></div>
        <div><label>Email</label><input id="o_email" type="email" /></div>
        <div><label>District *</label><select id="o_district" required><option value="">Loading...</option></select></div>
        <div><label>Office</label><input id="o_office" /></div>
      </div>
      <div id="o_error" class="error hidden"></div>
      <div id="o_success" class="success hidden"></div>
      <br />
      <button class="primary" id="o_submit" onclick="addOfficer()">Save Officer</button>
    </section>

    <section id="masters" class="card hidden">
      <h3>Add District</h3>
      <div class="row-3">
        <div><label>Name *</label><input id="d_name" required /></div>
        <div><label>Range</label><input id="d_range" /></div>
        <div><label>&nbsp;</label><button class="primary" id="d_submit" onclick="addDistrict()">Add District</button></div>
      </div>
      <div id="d_error" class="error hidden"></div>
      <div id="d_success" class="success hidden"></div>

      <h3 style="margin-top:24px">Add Station</h3>
      <div class="row-3">
        <div><label>Name *</label><input id="s_name" required /></div>
        <div><label>District *</label><select id="s_district" required><option value="">Select District</option></select></div>
        <div><label>STD Code</label><input id="s_std" /></div>
      </div>
      <div id="s_error" class="error hidden"></div>
      <div id="s_success" class="success hidden"></div>
      <br />
      <button class="primary" id="s_submit" onclick="addStation()">Add Station</button>
      
      <h3 style="margin-top:24px">Stations List</h3>
      <table id="stationsTable">
        <thead>
          <tr><th>Name</th><th>District</th><th>STD Code</th></tr>
        </thead>
        <tbody id="stationsTableBody">
          <tr><td colspan="3" style="text-align:center; color:#9ca3af;">Select a district to view stations</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_d5ueTul9vKeNw3pmEtCmbF9w1BVkrAQ",
      authDomain: "pmd-police-mobile-directory.firebaseapp.com",
      projectId: "pmd-police-mobile-directory"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ✅ Get DOM elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const tabs = document.getElementById('tabs');
    const userEmail = document.getElementById('userEmail');
    
    // Employee fields
    const e_kgid = document.getElementById('e_kgid');
    const e_name = document.getElementById('e_name');
    const e_mobile = document.getElementById('e_mobile');
    const e_designation = document.getElementById('e_designation');
    const e_district = document.getElementById('e_district');
    const e_station = document.getElementById('e_station');
    const e_submit = document.getElementById('e_submit');
    const e_error = document.getElementById('e_error');
    const e_success = document.getElementById('e_success');
    
    // Officer fields
    const o_rank = document.getElementById('o_rank');
    const o_name = document.getElementById('o_name');
    const o_mobile = document.getElementById('o_mobile');
    const o_email = document.getElementById('o_email');
    const o_district = document.getElementById('o_district');
    const o_office = document.getElementById('o_office');
    const o_submit = document.getElementById('o_submit');
    const o_error = document.getElementById('o_error');
    const o_success = document.getElementById('o_success');
    
    // District fields
    const d_name = document.getElementById('d_name');
    const d_range = document.getElementById('d_range');
    const d_submit = document.getElementById('d_submit');
    const d_error = document.getElementById('d_error');
    const d_success = document.getElementById('d_success');
    
    // Station fields
    const s_name = document.getElementById('s_name');
    const s_district = document.getElementById('s_district');
    const s_std = document.getElementById('s_std');
    const s_submit = document.getElementById('s_submit');
    const s_error = document.getElementById('s_error');
    const s_success = document.getElementById('s_success');
    
    // Stations table
    const stationsTableBody = document.getElementById('stationsTableBody');

    // ✅ Auth handlers
    loginBtn.onclick = () => {
      signInWithPopup(auth, provider).catch(err => {
        console.error('Login error:', err);
        alert('Login failed: ' + err.message);
      });
    };
    
    logoutBtn.onclick = () => {
      signOut(auth).catch(err => {
        console.error('Logout error:', err);
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        tabs.classList.remove('hidden');
        userEmail.textContent = user.email;
        userEmail.classList.remove('hidden');
        loadMasters();
      } else {
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        tabs.classList.add('hidden');
        userEmail.classList.add('hidden');
      }
    });

    // ✅ Tab switching
    document.querySelectorAll('nav button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      };
    });

    // ✅ Helper functions
    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId + '_error');
      const successEl = document.getElementById(elementId + '_success');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      }
      if (successEl) successEl.classList.add('hidden');
    }

    function showSuccess(elementId, message = 'Saved successfully!') {
      const successEl = document.getElementById(elementId + '_success');
      const errorEl = document.getElementById(elementId + '_error');
      if (successEl) {
        successEl.textContent = message;
        successEl.classList.remove('hidden');
        setTimeout(() => successEl.classList.add('hidden'), 3000);
      }
      if (errorEl) errorEl.classList.add('hidden');
    }

    function setLoading(elementId, isLoading) {
      const submitBtn = document.getElementById(elementId + '_submit');
      const section = document.getElementById(elementId.split('_')[0]);
      if (submitBtn) {
        submitBtn.disabled = isLoading;
        submitBtn.textContent = isLoading ? 'Saving...' : submitBtn.textContent.replace('Saving...', 'Save ' + elementId.split('_')[0].charAt(0).toUpperCase() + elementId.split('_')[0].slice(1));
      }
      if (section) {
        section.classList.toggle('loading', isLoading);
      }
    }

    function clearForm(prefix) {
      const fields = ['name', 'mobile', 'designation', 'district', 'station', 'kgid', 'rank', 'email', 'office', 'range', 'std'];
      fields.forEach(field => {
        const el = document.getElementById(prefix + '_' + field);
        if (el) el.value = '';
      });
    }

    // ✅ Load districts/stations
    async function loadMasters() {
      try {
        const snap = await getDocs(collection(db, 'districts'));
        const districts = snap.docs
          .map(d => d.data().name)
          .filter(name => name)
          .sort();
        
        const options = '<option value="">Select District</option>' + 
          districts.map(d => `<option value="${d}">${d}</option>`).join('');
        
        ['e_district', 'o_district', 's_district'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = options;
        });
      } catch (err) {
        console.error('Error loading districts:', err);
        ['e_district', 'o_district', 's_district'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = '<option value="">Error loading districts</option>';
        });
      }
    }

    // ✅ Load stations for employee dropdown
    async function loadEmployeeStations() {
      const district = e_district.value;
      if (!district) {
        e_station.innerHTML = '<option value="">Select District First</option>';
        return;
      }
      
      try {
        const q = query(collection(db, 'stations'), where('district', '==', district));
        const snap = await getDocs(q);
        const stations = snap.docs
          .map(s => s.data().name)
          .filter(name => name)
          .sort();
        
        e_station.innerHTML = '<option value="">Select Station</option>' + 
          stations.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (err) {
        console.error('Error loading stations:', err);
        e_station.innerHTML = '<option value="">Error loading stations</option>';
      }
    }

    // ✅ Load stations for master table
    async function loadStationsForMaster() {
      const district = s_district.value;
      if (!district) {
        stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">Select a district to view stations</td></tr>';
        return;
      }
      
      try {
        const q = query(collection(db, 'stations'), where('district', '==', district));
        const snap = await getDocs(q);
        
        if (snap.empty) {
          stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">No stations found for this district</td></tr>';
          return;
        }
        
        stationsTableBody.innerHTML = snap.docs.map(d => {
          const data = d.data();
          return `<tr>
            <td>${data.name || ''}</td>
            <td>${data.district || ''}</td>
            <td>${data.stdCode || ''}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('Error loading stations table:', err);
        stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#dc2626;">Error loading stations</td></tr>';
      }
    }

    // ✅ Add Employee
    window.addEmployee = async () => {
      // Validation
      if (!e_kgid.value.trim()) {
        showError('e', 'KGID is required');
        return;
      }
      if (!e_name.value.trim()) {
        showError('e', 'Name is required');
        return;
      }
      if (!e_mobile.value.trim()) {
        showError('e', 'Mobile is required');
        return;
      }
      if (!e_district.value) {
        showError('e', 'District is required');
        return;
      }
      if (!e_station.value) {
        showError('e', 'Station is required');
        return;
      }

      setLoading('e', true);
      
      try {
        await addDoc(collection(db, 'employees'), {
          kgid: e_kgid.value.trim(),
          name: e_name.value.trim(),
          mobile: e_mobile.value.trim(),
          designation: e_designation.value.trim() || null,
          district: e_district.value,
          station: e_station.value,
          createdAt: serverTimestamp()
        });
        
        showSuccess('e', 'Employee added successfully!');
        clearForm('e');
      } catch (err) {
        console.error('Error adding employee:', err);
        showError('e', 'Failed to add employee: ' + err.message);
      } finally {
        setLoading('e', false);
      }
    };

    // ✅ Add Officer
    window.addOfficer = async () => {
      // Validation
      if (!o_rank.value.trim()) {
        showError('o', 'Rank is required');
        return;
      }
      if (!o_name.value.trim()) {
        showError('o', 'Name is required');
        return;
      }
      if (!o_mobile.value.trim()) {
        showError('o', 'Mobile is required');
        return;
      }
      if (!o_district.value) {
        showError('o', 'District is required');
        return;
      }

      setLoading('o', true);
      
      try {
        await addDoc(collection(db, 'officers'), {
          rank: o_rank.value.trim(),
          name: o_name.value.trim(),
          mobile: o_mobile.value.trim(),
          email: o_email.value.trim() || null,
          district: o_district.value,
          office: o_office.value.trim() || null,
          createdAt: serverTimestamp()
        });
        
        showSuccess('o', 'Officer added successfully!');
        clearForm('o');
      } catch (err) {
        console.error('Error adding officer:', err);
        showError('o', 'Failed to add officer: ' + err.message);
      } finally {
        setLoading('o', false);
      }
    };

    // ✅ Add District
    window.addDistrict = async () => {
      if (!d_name.value.trim()) {
        showError('d', 'District name is required');
        return;
      }

      setLoading('d', true);
      
      try {
        await addDoc(collection(db, 'districts'), {
          name: d_name.value.trim(),
          range: d_range.value.trim() || null,
          isActive: true,
          createdAt: serverTimestamp()
        });
        
        showSuccess('d', 'District added successfully!');
        clearForm('d');
        await loadMasters(); // Reload dropdowns
      } catch (err) {
        console.error('Error adding district:', err);
        showError('d', 'Failed to add district: ' + err.message);
      } finally {
        setLoading('d', false);
      }
    };

    // ✅ Add Station
    window.addStation = async () => {
      if (!s_name.value.trim()) {
        showError('s', 'Station name is required');
        return;
      }
      if (!s_district.value) {
        showError('s', 'District is required');
        return;
      }

      setLoading('s', true);
      
      try {
        await addDoc(collection(db, 'stations'), {
          name: s_name.value.trim(),
          district: s_district.value,
          stdCode: s_std.value.trim() || null,
          isActive: true,
          createdAt: serverTimestamp()
        });
        
        showSuccess('s', 'Station added successfully!');
        clearForm('s');
        await loadStationsForMaster(); // Refresh table
      } catch (err) {
        console.error('Error adding station:', err);
        showError('s', 'Failed to add station: ' + err.message);
      } finally {
        setLoading('s', false);
      }
    };

    // ✅ Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      e_district.addEventListener('change', loadEmployeeStations);
      s_district.addEventListener('change', loadStationsForMaster);
    });

    // ✅ Initial load
    setTimeout(loadMasters, 500);

  </script>
</body>
</html>











