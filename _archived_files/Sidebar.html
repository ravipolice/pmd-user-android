<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 10px; }
      h2 { color: #1a73e8; margin-bottom: 20px; }

      input, select {
        width: 100%; padding: 8px; margin: 5px 0 10px 0;
        border: 1px solid #ccc; border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background: #1a73e8; 
        color: white; 
        padding: 10px; 
        border: none; 
        cursor: pointer; 
        width: 100%;
        border-radius: 4px;
        margin-top: 5px;
      }

      button:hover { background: #155ec3; }
      button:disabled { background: #ccc; cursor: not-allowed; }

      .box { 
        border: 1px solid #ddd; 
        padding: 12px; 
        border-radius: 6px; 
        margin-bottom: 20px; 
        background: #fafafa;
      }

      .success { 
        color: #0f9d58; 
        font-size: 12px; 
        margin-top: 5px; 
        display: none;
      }

      .error { 
        color: #ea4335; 
        font-size: 12px; 
        margin-top: 5px; 
        display: none;
      }

      label {
        font-weight: bold;
        display: block;
        margin-top: 5px;
      }
    </style>
  </head>

  <body>

    <h2>Constants Manager</h2>

    <!-- Add Rank -->
    <div class="box">
      <h3>Add Rank</h3>
      <input id="rankInput" placeholder="Enter Rank Name (e.g., APC, CPC, WPC)">
      <div id="rankSuccess" class="success">✓ Rank added successfully!</div>
      <div id="rankError" class="error"></div>
      <button id="rankButton" onclick="addRank()">Add Rank</button>
    </div>

    <!-- Add District -->
    <div class="box">
      <h3>Add District</h3>
      <input id="districtInput" placeholder="Enter District Name">
      <div id="districtSuccess" class="success">✓ District added successfully!</div>
      <div id="districtError" class="error"></div>
      <button id="districtButton" onclick="addDistrict()">Add District</button>
    </div>

    <!-- Add Station -->
    <div class="box">
      <h3>Add Station</h3>

      <label>Select District:</label>
      <select id="districtDropdown"></select>

      <label>Station Name:</label>
      <input id="stationInput" placeholder="Enter Station Name">
      <div id="stationSuccess" class="success">✓ Station added successfully!</div>
      <div id="stationError" class="error"></div>
      <button id="stationButton" onclick="addStation()">Add Station</button>
    </div>

    <script>
      /** Load district dropdown on sidebar load */
      function loadDistricts() {
        google.script.run.withSuccessHandler(function(list) {
          const dropdown = document.getElementById("districtDropdown");
          dropdown.innerHTML = "";

          if (list && list.length > 0) {
            list.forEach(d => {
              const option = document.createElement("option");
              option.value = d;
              option.textContent = d;
              dropdown.appendChild(option);
            });
          } else {
            const option = document.createElement("option");
            option.textContent = "No districts found";
            option.disabled = true;
            dropdown.appendChild(option);
          }
        }).withFailureHandler(function(err) {
          console.error("Failed to load districts:", err);
          const dropdown = document.getElementById("districtDropdown");
          dropdown.innerHTML = '<option>Error loading districts</option>';
        }).getDistrictList();
      }

      // Load districts when sidebar opens
      loadDistricts();

      /** Show success message */
      function showSuccess(elementId) {
        const successEl = document.getElementById(elementId + "Success");
        const errorEl = document.getElementById(elementId + "Error");
        if (successEl) {
          successEl.style.display = "block";
          setTimeout(() => { successEl.style.display = "none"; }, 3000);
        }
        if (errorEl) errorEl.style.display = "none";
      }

      /** Show error message */
      function showError(elementId, message) {
        const errorEl = document.getElementById(elementId + "Error");
        const successEl = document.getElementById(elementId + "Success");
        if (errorEl) {
          errorEl.textContent = "✗ " + message;
          errorEl.style.display = "block";
        }
        if (successEl) successEl.style.display = "none";
      }

      /** Clear input field */
      function clearInput(elementId) {
        const input = document.getElementById(elementId);
        if (input) input.value = "";
      }

      /** Add Rank */
      function addRank() {
        const value = document.getElementById("rankInput").value.trim();
        if (!value) { 
          showError("rank", "Please enter a rank name.");
          return; 
        }

        const button = document.getElementById("rankButton");
        button.disabled = true;
        button.textContent = "Adding...";

        google.script.run
          .withSuccessHandler(function(result) {
            button.disabled = false;
            button.textContent = "Add Rank";
            
            if (result && result.success) {
              showSuccess("rank");
              clearInput("rankInput");
            } else {
              showError("rank", result?.error || "Failed to add rank.");
            }
          })
          .withFailureHandler(function(err) {
            button.disabled = false;
            button.textContent = "Add Rank";
            showError("rank", err.message || "Error: " + err);
          })
          .addRankToSheet(value);
      }

      /** Add District */
      function addDistrict() {
        const value = document.getElementById("districtInput").value.trim();
        if (!value) { 
          showError("district", "Please enter a district name.");
          return; 
        }

        const button = document.getElementById("districtButton");
        button.disabled = true;
        button.textContent = "Adding...";

        google.script.run
          .withSuccessHandler(function(result) {
            button.disabled = false;
            button.textContent = "Add District";
            
            if (result && result.success) {
              showSuccess("district");
              clearInput("districtInput");
              // Reload district dropdown to include new district
              loadDistricts();
            } else {
              showError("district", result?.error || "Failed to add district.");
            }
          })
          .withFailureHandler(function(err) {
            button.disabled = false;
            button.textContent = "Add District";
            showError("district", err.message || "Error: " + err);
          })
          .addDistrictToSheet(value);
      }

      /** Add Station */
      function addStation() {
        const district = document.getElementById("districtDropdown").value;
        const station = document.getElementById("stationInput").value.trim();

        if (!station) { 
          showError("station", "Please enter a station name.");
          return; 
        }

        if (!district || district === "No districts found" || district === "Error loading districts") {
          showError("station", "Please select a valid district.");
          return;
        }

        const button = document.getElementById("stationButton");
        button.disabled = true;
        button.textContent = "Adding...";

        google.script.run
          .withSuccessHandler(function(result) {
            button.disabled = false;
            button.textContent = "Add Station";
            
            if (result && result.success) {
              showSuccess("station");
              clearInput("stationInput");
            } else {
              showError("station", result?.error || "Failed to add station.");
            }
          })
          .withFailureHandler(function(err) {
            button.disabled = false;
            button.textContent = "Add Station";
            showError("station", err.message || "Error: " + err);
          })
          .addStationToSheet(district, station);
      }

      // Allow Enter key to submit
      document.getElementById("rankInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") addRank();
      });

      document.getElementById("districtInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") addDistrict();
      });

      document.getElementById("stationInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") addStation();
      });
    </script>

  </body>
</html>
