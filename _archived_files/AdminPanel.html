<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMD Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f4f6f8; }
    header { background:#1f2937; color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    nav { background:#111827; color:#fff; padding:8px; display:flex; gap:8px; }
    nav button { background:#374151; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:6px; }
    nav button.active { background:#2563eb; }
    main { padding:16px; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.06); margin-bottom:16px; }
    .row { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .row-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    label { font-size:12px; color:#374151; font-weight:500; }
    input, select { width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db; box-sizing:border-box; }
    button.primary { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:500; }
    button.primary:hover { background:#1d4ed8; }
    button.primary:disabled { background:#9ca3af; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:13px; text-align:left; }
    th { background:#f9fafb; color:#374151; font-weight:600; }
    .hidden { display:none; }
    .error { color:#dc2626; font-size:12px; margin-top:4px; }
    .success { color:#16a34a; font-size:12px; margin-top:4px; }
    .loading { opacity:0.6; pointer-events:none; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div><strong>PMD Admin Panel</strong></div>
    <div>
      <span id="userEmail" class="hidden" style="margin-right:12px; font-size:14px;"></span>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </header>

  <nav id="tabs" class="hidden">
    <button data-tab="employees" class="active">Employees</button>
    <button data-tab="officers">Officers</button>
    <button data-tab="masters">Districts & Stations</button>
  </nav>

  <main>
    <section id="employees" class="card">
      <h3>Add Employee</h3>
      <div class="row">
        <div><label>KGID *</label><input id="e_kgid" required /></div>
        <div><label>Name *</label><input id="e_name" required /></div>
        <div><label>Mobile *</label><input id="e_mobile" type="tel" required /></div>
        <div><label>Designation</label><input id="e_designation" /></div>
        <div><label>District *</label><select id="e_district" required><option value="">Loading...</option></select></div>
        <div><label>Station *</label><select id="e_station" required><option value="">Select District First</option></select></div>
      </div>
      <div id="e_error" class="error hidden"></div>
      <div id="e_success" class="success hidden"></div>
      <br />
      <button class="primary" id="e_submit" onclick="addEmployee()">Save Employee</button>
    </section>

    <section id="officers" class="card hidden">
      <h3>Add Officer</h3>
      <div class="row">
        <div><label>Rank *</label><input id="o_rank" required /></div>
        <div><label>Name *</label><input id="o_name" required /></div>
        <div><label>Mobile *</label><input id="o_mobile" type="tel" required /></div>
        <div><label>Email</label><input id="o_email" type="email" /></div>
        <div><label>District *</label><select id="o_district" required><option value="">Loading...</option></select></div>
        <div><label>Office</label><input id="o_office" /></div>
      </div>
      <div id="o_error" class="error hidden"></div>
      <div id="o_success" class="success hidden"></div>
      <br />
      <button class="primary" id="o_submit" onclick="addOfficer()">Save Officer</button>
    </section>

    <section id="masters" class="card hidden">
      <h3>Add District</h3>
      <div class="row-3">
        <div><label>Name *</label><input id="d_name" required /></div>
        <div><label>Range</label><input id="d_range" /></div>
        <div><label>&nbsp;</label><button class="primary" id="d_submit" onclick="addDistrict()">Add District</button></div>
      </div>
      <div id="d_error" class="error hidden"></div>
      <div id="d_success" class="success hidden"></div>

      <h3 style="margin-top:24px">Add Station</h3>
      <div class="row-3">
        <div><label>Name *</label><input id="s_name" required /></div>
        <div><label>District *</label><select id="s_district" required><option value="">Select District</option></select></div>
        <div><label>STD Code</label><input id="s_std" /></div>
      </div>
      <div id="s_error" class="error hidden"></div>
      <div id="s_success" class="success hidden"></div>
      <br />
      <button class="primary" id="s_submit" onclick="addStation()">Add Station</button>

      <h3 style="margin-top:24px">Add Unit</h3>
      <div class="row-3">
        <div><label>Name *</label><input id="u_name" required /></div>
        <div>
          <label>Scope</label><br>
          <input type="checkbox" id="u_hqState" name="unit_scope" value="state"> HQ (State Level)<br>
          <input type="checkbox" id="u_districtLevel" name="unit_scope" value="district"> District Level<br>
          <input type="checkbox" id="u_battalion" name="unit_scope" value="battalion"> Battalion<br>
          <input type="checkbox" id="u_commissionerate" name="unit_scope" value="commissionerate"> Commissionerate
        </div>
        <div><label>Mapped Districts</label><select id="u_mappedDistricts" multiple style="display:none;"><option value="">Loading...</option></select></div>
        <div><label>&nbsp;</label><button class="primary" id="u_submit" onclick="addUnit()">Add Unit</button></div>
      </div>
      <div id="u_error" class="error hidden"></div>
      <div id="u_success" class="success hidden"></div>

      <h3 style="margin-top:24px">Units List</h3>
      <table id="unitsTable">
        <thead>
          <tr><th>Name</th><th>Scope</th><th>Actions</th></tr>
        </thead>
        <tbody id="unitsTableBody">
          <tr><td colspan="3" style="text-align:center; color:#9ca3af;">Loading units...</td></tr>
        </tbody>
      </table>

      <h3 style="margin-top:24px">Stations List</h3>
      <table id="stationsTable">
        <thead>
          <tr><th>Name</th><th>District</th><th>STD Code</th></tr>
        </thead>
        <tbody id="stationsTableBody">
          <tr><td colspan="3" style="text-align:center; color:#9ca3af;">Select a district to view stations</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_d5ueTul9vKeNw3pmEtCmbF9w1BVkrAQ",
      authDomain: "pmd-police-mobile-directory.firebaseapp.com",
      projectId: "pmd-police-mobile-directory"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ✅ Get DOM elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const tabs = document.getElementById('tabs');
    const userEmail = document.getElementById('userEmail');
    
    // Employee fields
    const e_kgid = document.getElementById('e_kgid');
    const e_name = document.getElementById('e_name');
    const e_mobile = document.getElementById('e_mobile');
    const e_designation = document.getElementById('e_designation');
    const e_district = document.getElementById('e_district');
    const e_station = document.getElementById('e_station');
    const e_submit = document.getElementById('e_submit');
    const e_error = document.getElementById('e_error');
    const e_success = document.getElementById('e_success');
    
    // Officer fields
    const o_rank = document.getElementById('o_rank');
    const o_name = document.getElementById('o_name');
    const o_mobile = document.getElementById('o_mobile');
    const o_email = document.getElementById('o_email');
    const o_district = document.getElementById('o_district');
    const o_office = document.getElementById('o_office');
    const o_submit = document.getElementById('o_submit');
    const o_error = document.getElementById('o_error');
    const o_success = document.getElementById('o_success');
    
    // District fields
    const d_name = document.getElementById('d_name');
    const d_range = document.getElementById('d_range');
    const d_submit = document.getElementById('d_submit');
    const d_error = document.getElementById('d_error');
    const d_success = document.getElementById('d_success');
    
    // Station fields
    const s_name = document.getElementById('s_name');
    const s_district = document.getElementById('s_district');
    const s_std = document.getElementById('s_std');
    const s_submit = document.getElementById('s_submit');
    const s_error = document.getElementById('s_error');
    const s_success = document.getElementById('s_success');

    // Unit fields
    const u_name = document.getElementById('u_name');
    // New scope fields for Add Unit
    const u_hqState = document.getElementById('u_hqState');
    const u_districtLevel = document.getElementById('u_districtLevel');
    const u_battalion = document.getElementById('u_battalion');
    const u_commissionerate = document.getElementById('u_commissionerate');
    const u_mappedDistricts = document.getElementById('u_mappedDistricts'); // Assuming a multi-select or text input
    
    const u_submit = document.getElementById('u_submit');
    const u_error = document.getElementById('u_error');
    const u_success = document.getElementById('u_success');

    // Units table
    const unitsTableBody = document.getElementById('unitsTableBody');

    // Stations table
    const stationsTableBody = document.getElementById('stationsTableBody');

    // Edit Unit Modal elements
    const editUnitModal = document.getElementById('editUnitModal');
    const edit_u_id = document.getElementById('edit_u_id');
    const edit_u_name = document.getElementById('edit_u_name');
    // New scope fields for Edit Unit Modal
    const edit_u_hqState = document.getElementById('edit_u_hqState');
    const edit_u_districtLevel = document.getElementById('edit_u_districtLevel');
    const edit_u_battalion = document.getElementById('edit_u_battalion');
    const edit_u_commissionerate = document.getElementById('edit_u_commissionerate');
    const edit_u_mappedDistricts = document.getElementById('edit_u_mappedDistricts'); // Assuming a multi-select or text input

    const edit_u_error = document.getElementById('edit_u_error');
    const edit_u_success = document.getElementById('edit_u_success');
    const edit_u_submit = document.getElementById('edit_u_submit');
    
    // ✅ Auth handlers
    loginBtn.onclick = () => {
      signInWithPopup(auth, provider).catch(err => {
        console.error('Login error:', err);
        alert('Login failed: ' + err.message);
      });
    };
    
    logoutBtn.onclick = () => {
      signOut(auth).catch(err => {
        console.error('Logout error:', err);
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        tabs.classList.remove('hidden');
        userEmail.textContent = user.email;
        userEmail.classList.remove('hidden');
        loadMasters();
      } else {
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        tabs.classList.add('hidden');
        userEmail.classList.add('hidden');
      }
    });

    // ✅ Tab switching
    document.querySelectorAll('nav button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      };
    });

    // ✅ Helper functions
    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId + '_error');
      const successEl = document.getElementById(elementId + '_success');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      }
      if (successEl) successEl.classList.add('hidden');
    }

    function showSuccess(elementId, message = 'Saved successfully!') {
      const successEl = document.getElementById(elementId + '_success');
      const errorEl = document.getElementById(elementId + '_error');
      if (successEl) {
        successEl.textContent = message;
        successEl.classList.remove('hidden');
        setTimeout(() => successEl.classList.add('hidden'), 3000);
      }
      if (errorEl) errorHl.classList.add('hidden');
    }

    function setLoading(elementId, isLoading) {
      const submitBtn = document.getElementById(elementId + '_submit');
      const section = document.getElementById(elementId.split('_')[0]);
      if (submitBtn) {
        submitBtn.disabled = isLoading;
        submitBtn.textContent = isLoading ? 'Saving...' : submitBtn.textContent.replace('Saving...', 'Save ' + elementId.split('_')[0].charAt(0).toUpperCase() + elementId.split('_')[0].slice(1));
      }
      if (section) {
        section.classList.toggle('loading', isLoading);
      }
    }

    function clearForm(prefix) {
      const fields = ['name', 'mobile', 'designation', 'district', 'station', 'kgid', 'rank', 'email', 'office', 'range', 'std', 'hqState', 'districtLevel', 'battalion', 'commissionerate', 'mappedDistricts'];
      fields.forEach(field => {
        const el = document.getElementById(prefix + '_' + field);
        if (el) {
          if (el.type === 'checkbox') {
            el.checked = false;
          } else {
            el.value = '';
          }
        }
      });
    }

    // ✅ Load districts/stations/units
    async function loadMasters() {
      try {
        const districtsSnap = await getDocs(collection(db, 'districts'));
        const districts = districtsSnap.docs
          .map(d => d.data().name)
          .filter(name => name)
          .sort();

        const districtOptions = '<option value="">Select District</option>' +
          districts.map(d => `<option value="${d}">${d}</option>`).join('');

        ['e_district', 'o_district', 's_district', 'u_mappedDistricts', 'edit_u_mappedDistricts'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = districtOptions;
        });

        // Load battalions (assuming a 'battalions' collection)
        const battalionsSnap = await getDocs(collection(db, 'battalions'));
        const battalions = battalionsSnap.docs
          .map(b => b.data().name)
          .filter(name => name)
          .sort();
        
        // Load commissionerates (assuming a 'commissionerates' collection)
        const commissioneratesSnap = await getDocs(collection(db, 'commissionerates'));
        const commissionerates = commissioneratesSnap.docs
          .map(c => c.data().name)
          .filter(name => name)
          .sort();

      } catch (err) {
        console.error('Error loading masters:', err);
        // ... error handling for dropdowns ...
      }

      await loadUnitsForMaster();
    }

    // ✅ Load stations for employee dropdown
    async function loadEmployeeStations() {
      const district = e_district.value;
      if (!district) {
        e_station.innerHTML = '<option value="">Select District First</option>';
        return;
      }
      
      try {
        const q = query(collection(db, 'stations'), where('district', '==', district));
        const snap = await getDocs(q);
        const stations = snap.docs
          .map(s => s.data().name)
          .filter(name => name)
          .sort();
        
        e_station.innerHTML = '<option value="">Select Station</option>' + 
          stations.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (err) {
        console.error('Error loading stations:', err);
        e_station.innerHTML = '<option value="">Error loading stations</option>';
      }
    }

    // ✅ Load stations for master table
    async function loadStationsForMaster() {
      const district = s_district.value;
      if (!district) {
        stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">Select a district to view stations</td></tr>';
        return;
      }

      try {
        const q = query(collection(db, 'stations'), where('district', '==', district));
        const snap = await getDocs(q);

        if (snap.empty) {
          stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">No stations found for this district</td></tr>';
          return;
        }

        stationsTableBody.innerHTML = snap.docs.map(d => {
          const data = d.data();
          return `<tr>
            <td>${data.name || ''}</td>
            <td>${data.district || ''}</td>
            <td>${data.stdCode || ''}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('Error loading stations table:', err);
        stationsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#dc2626;">Error loading stations</td></tr>';
      }
    }

    // ✅ Load units for master table
    window.loadUnitsForMaster = async () => {
      try {
        const q = query(collection(db, 'units'), where('isActive', '==', true));
        const snap = await getDocs(q);

        if (snap.empty) {
          unitsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">No units found</td></tr>';
          return;
        }

        unitsTableBody.innerHTML = snap.docs.map(d => {
          const data = d.data();
          const unitId = d.id;
          let scopeDisplay = '';

          if (data.mappingType === 'all') {
              scopeDisplay = 'All';
          } else if (data.mappingType === 'state') {
              scopeDisplay = 'HQ (State Level)';
          } else if (data.mappingType === 'district') {
              scopeDisplay = 'District Level';
          } else if (data.mappingType === 'commissionerate') {
              scopeDisplay = 'Commissionerate';
          } else if (data.mappingType === 'battalion') {
              scopeDisplay = 'Battalion';
          } else if (data.mappingType === 'subset' && data.mappedDistricts && data.mappedDistricts.length > 0) {
              scopeDisplay = `Custom: ${data.mappedDistricts.join(', ')}`;
          } else {
              scopeDisplay = 'None';
          }

          return `<tr>
            <td>${data.name || ''}</td>
            <td>${scopeDisplay}</td>
            <td>
              <button onclick="openEditUnitModal('${unitId}', '${data.name || ''}', '${data.mappingType || ''}', '${JSON.stringify(data.mappedDistricts || [])}', ${data.isDistrictLevel || false})">Edit</button>
              <button onclick="deleteUnit('${unitId}')">Delete</button>
            </td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('Error loading units table:', err);
        unitsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#dc2626;">Error loading units</td></tr>';
      }
    };

    // ✅ Add Employee
    window.addEmployee = async () => {
      // Validation
      if (!e_kgid.value.trim()) {
        showError('e', 'KGID is required');
        return;
      }
      if (!e_name.value.trim()) {
        showError('e', 'Name is required');
        return;
      }
      if (!e_mobile.value.trim()) {
        showError('e', 'Mobile is required');
        return;
      }
      if (!e_district.value) {
        showError('e', 'District is required');
        return;
      }
      if (!e_station.value) {
        showError('e', 'Station is required');
        return;
      }

      setLoading('e', true);
      
      try {
        await addDoc(collection(db, 'employees'), {
          kgid: e_kgid.value.trim(),
          name: e_name.value.trim(),
          mobile: e_mobile.value.trim(),
          designation: e_designation.value.trim() || null,
          district: e_district.value,
          station: e_station.value,
          createdAt: serverTimestamp()
        });
        
        showSuccess('e', 'Employee added successfully!');
        clearForm('e');
      } catch (err) {
        console.error('Error adding employee:', err);
        showError('e', 'Failed to add employee: ' + err.message);
      } finally {
        setLoading('e', false);
      }
    };

    // ✅ Add Officer
    window.addOfficer = async () => {
      // Validation
      if (!o_rank.value.trim()) {
        showError('o', 'Rank is required');
        return;
      }
      if (!o_name.value.trim()) {
        showError('o', 'Name is required');
        return;
      }
      if (!o_mobile.value.trim()) {
        showError('o', 'Mobile is required');
        return;
      }
      if (!o_district.value) {
        showError('o', 'District is required');
        return;
      }

      setLoading('o', true);
      
      try {
        await addDoc(collection(db, 'officers'), {
          rank: o_rank.value.trim(),
          name: o_name.value.trim(),
          mobile: o_mobile.value.trim(),
          email: o_email.value.trim() || null,
          district: o_district.value,
          office: o_office.value.trim() || null,
          createdAt: serverTimestamp()
        });
        
        showSuccess('o', 'Officer added successfully!');
        clearForm('o');
      } catch (err) {
        console.error('Error adding officer:', err);
        showError('o', 'Failed to add officer: ' + err.message);
      } finally {
        setLoading('o', false);
      }
    };

    // ✅ Add District
    window.addDistrict = async () => {
      if (!d_name.value.trim()) {
        showError('d', 'District name is required');
        return;
      }

      setLoading('d', true);
      
      try {
        await addDoc(collection(db, 'districts'), {
          name: d_name.value.trim(),
          range: d_range.value.trim() || null,
          isActive: true,
          createdAt: serverTimestamp()
        });
        
        showSuccess('d', 'District added successfully!');
        clearForm('d');
        await loadMasters(); // Reload dropdowns
      } catch (err) {
        console.error('Error adding district:', err);
        showError('d', 'Failed to add district: ' + err.message);
      } finally {
        setLoading('d', false);
      }
    };

    // ✅ Add Station
    window.addStation = async () => {
      if (!s_name.value.trim()) {
        showError('s', 'Station name is required');
        return;
      }
      if (!s_district.value) {
        showError('s', 'District is required');
        return;
      }

      setLoading('s', true);

      try {
        await addDoc(collection(db, 'stations'), {
          name: s_name.value.trim(),
          district: s_district.value,
          stdCode: s_std.value.trim() || null,
          isActive: true,
          createdAt: serverTimestamp()
        });

        showSuccess('s', 'Station added successfully!');
        clearForm('s');
        await loadStationsForMaster(); // Refresh table
      } catch (err) {
        console.error('Error adding station:', err);
        showError('s', 'Failed to add station: ' + err.message);
      } finally {
        setLoading('s', false);
      }
    };

    // ✅ Add Unit
    window.addUnit = async () => {
      if (!u_name.value.trim()) {
        showError('u', 'Unit name is required');
        return;
      }

      // Determine mappingType and scopes based on checkboxes
      let mappingType = 'none';
      const scopes = [];
      const mappedDistricts = [];

      if (u_hqState.checked) {
          mappingType = 'state';
          scopes.push('HQ (State Level)');
      } else if (u_districtLevel.checked) {
          mappingType = 'district';
          scopes.push('District Level');
          // Assuming u_mappedDistricts is a multi-select for now
          Array.from(u_mappedDistricts.options).filter(option => option.selected).map(option => mappedDistricts.push(option.value));
          if (mappedDistricts.length === 0) {
              showError('u', 'Please select at least one district for District Level scope');
              return;
          }
      } else if (u_battalion.checked) {
          mappingType = 'battalion';
          scopes.push('Battalion');
      } else if (u_commissionerate.checked) {
          mappingType = 'commissionerate';
          scopes.push('Commissionerate');
      } else {
          mappingType = 'all'; // Default if none selected
          scopes.push('All');
      }


      setLoading('u', true);

      try {
        await addDoc(collection(db, 'units'), {
          name: u_name.value.trim(),
          isActive: true,
          mappingType: mappingType,
          mappedDistricts: mappedDistricts,
          isDistrictLevel: u_districtLevel.checked, // Set based on checkbox
          scopes: scopes, // Store selected scopes
          createdAt: serverTimestamp()
        });

        showSuccess('u', 'Unit added successfully!');
        clearForm('u');
        await loadUnitsForMaster(); // Refresh table
      } catch (err) {
        console.error('Error adding unit:', err);
        showError('u', 'Failed to add unit: ' + err.message);
      } finally {
        setLoading('u', false);
      }
    };

    // New: Open Edit Unit Modal
    window.openEditUnitModal = (id, name, mappingType, mappedDistrictsJson, isDistrictLevel) => {
        edit_u_id.value = id;
        edit_u_name.value = name;
        
        // Reset checkboxes
        edit_u_hqState.checked = false;
        edit_u_districtLevel.checked = false;
        edit_u_battalion.checked = false;
        edit_u_commissionerate.checked = false;
        edit_u_mappedDistricts.style.display = 'none'; // Hide by default

        // Set scopes
        if (mappingType === 'state') {
            edit_u_hqState.checked = true;
        } else if (mappingType === 'district') {
            edit_u_districtLevel.checked = true;
            edit_u_mappedDistricts.style.display = 'block';
            const currentMappedDistricts = JSON.parse(mappedDistrictsJson);
            Array.from(edit_u_mappedDistricts.options).forEach(option => {
                option.selected = currentMappedDistricts.includes(option.value);
            });
        } else if (mappingType === 'battalion') {
            edit_u_battalion.checked = true;
        } else if (mappingType === 'commissionerate') {
            edit_u_commissionerate.checked = true;
        }


        editUnitModal.style.display = 'flex'; // Show modal
    };

    // New: Close Edit Unit Modal
    window.closeEditUnitModal = () => {
        editUnitModal.style.display = 'none';
        showError('edit_u', ''); // Clear errors
        showSuccess('edit_u', ''); // Clear success messages
        clearForm('edit_u');
    };

    // New: Update Unit
    window.updateUnit = async () => {
        if (!edit_u_name.value.trim()) {
            showError('edit_u', 'Unit name is required');
            return;
        }

        let mappingType = 'none';
        const scopes = [];
        const mappedDistricts = [];

        if (edit_u_hqState.checked) {
            mappingType = 'state';
            scopes.push('HQ (State Level)');
        } else if (edit_u_districtLevel.checked) {
            mappingType = 'district';
            scopes.push('District Level');
            Array.from(edit_u_mappedDistricts.options).filter(option => option.selected).map(option => mappedDistricts.push(option.value));
            if (mappedDistricts.length === 0) {
                showError('edit_u', 'Please select at least one district for District Level scope');
                return;
            }
        } else if (edit_u_battalion.checked) {
            mappingType = 'battalion';
            scopes.push('Battalion');
        } else if (edit_u_commissionerate.checked) {
            mappingType = 'commissionerate';
            scopes.push('Commissionerate');
        } else {
            mappingType = 'all'; // Default if none selected
            scopes.push('All');
        }

        setLoading('edit_u', true);
        try {
            // Call Google Apps Script backend to update unit
            await fetch('https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?action=updateUnit', {
                method: 'POST',
                body: JSON.stringify({
                    id: edit_u_id.value,
                    name: edit_u_name.value.trim(),
                    isActive: true, // Assuming active by default for now
                    mappingType: mappingType,
                    mappedDistricts: mappedDistricts,
                    isDistrictLevel: edit_u_districtLevel.checked,
                    scopes: scopes
                })
            });
            showSuccess('edit_u', 'Unit updated successfully!');
            closeEditUnitModal();
            loadUnitsForMaster(); // Refresh table
        } catch (err) {
            console.error('Error updating unit:', err);
            showError('edit_u', 'Failed to update unit: ' + err.message);
        } finally {
            setLoading('edit_u', false);
        }
    };

    // New: Delete Unit
    window.deleteUnit = async (unitId) => {
        if (!confirm('Are you sure you want to delete this unit?')) {
            return;
        }
        setLoading('units', true); // Indicate loading on the main units section
        try {
            // Call Google Apps Script backend to delete unit
            await fetch('https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?action=deleteUnit', {
                method: 'POST',
                body: JSON.stringify({ id: unitId })
            });
            showSuccess('units', 'Unit deleted successfully!');
            loadUnitsForMaster(); // Refresh table
        } catch (err) {
            console.error('Error deleting unit:', err);
            showError('units', 'Failed to delete unit: ' + err.message);
        } finally {
            setLoading('units', false);
        }
    };

    // Event listeners for dynamic scope fields
    document.addEventListener('change', () => {
        const isDistrictLevelChecked = u_districtLevel.checked || edit_u_districtLevel.checked;
        if (isDistrictLevelChecked) {
            u_mappedDistricts.style.display = 'block';
            edit_u_mappedDistricts.style.display = 'block';
        } else {
            u_mappedDistricts.style.display = 'none';
            edit_u_mappedDistricts.style.display = 'none';
        }
    });

    // ✅ Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      e_district.addEventListener('change', loadEmployeeStations);
      s_district.addEventListener('change', loadStationsForMaster);

      // Trigger change event to set initial visibility of mappedDistricts dropdown
      document.dispatchEvent(new Event('change'));
    });

    // ✅ Initial load
    setTimeout(loadMasters, 500);

  </script>
  <!-- Edit Unit Modal -->
  <div id="editUnitModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button" onclick="closeEditUnitModal()">&times;</span>
      <h3>Edit Unit</h3>
      <input type="hidden" id="edit_u_id">
      <div><label>Unit Name *</label><input id="edit_u_name" required /></div>
      <div id="edit_u_error" class="error hidden"></div>
      <div id="edit_u_success" class="success hidden"></div>
      <br />
      <button class="primary" id="edit_u_submit" onclick="updateUnit()">Save Changes</button>
    </div>
  </div>

</body>
</html>