rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================================================
       ðŸ” OPTIMIZED ADMIN HELPERS
    ============================================================ */

    function isAuthenticated() {
      return request.auth != null;
    }

    function hasAuthEmail() {
      return request.auth.token.email != null
             && request.auth.token.email is string;
    }

    /* ---------- 1ï¸âƒ£ UID-Based Admin ---------- */
    function isUidAdmin() {
      return request.auth.uid != null
          && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
          && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isActive == true;
    }

    /* ---------- 2ï¸âƒ£ Email-Based Admin ---------- */
    function isEmailAdmin() {
      return hasAuthEmail()
          && exists(/databases/$(database)/documents/admins/$(request.auth.token.email))
          && get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.isActive == true
          && get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.email == request.auth.token.email;
    }

    /* ---------- 3ï¸âƒ£ Employee Fallback Admin ---------- */
    function isEmployeeAdmin() {
      return (
        hasAuthEmail()
        && request.auth.uid != null
        && exists(/databases/$(database)/documents/employees/$(request.auth.token.email))
        && get(/databases/$(database)/documents/employees/$(request.auth.token.email)).data.isAdmin == true
        && get(/databases/$(database)/documents/employees/$(request.auth.token.email)).data.firebaseUid == request.auth.uid
      )
      || (
        request.auth.uid != null
        && exists(/databases/$(database)/documents/employees/$(request.auth.uid))
        && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.isAdmin == true
      );
    }

    /* ---------- Final Admin Evaluator ---------- */
    function isAdmin() {
      return isAuthenticated()
          && (isUidAdmin() || isEmailAdmin() || isEmployeeAdmin());
    }

    function isServiceAccount() {
      return request.auth != null
          && request.auth.token.firebase != null
          && request.auth.token.firebase.sign_in_provider == "service_account";
    }

    function isValidEmail(email) {
      return email.matches('^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$');
    }


    /* ============================================================
       ðŸ”¹ OTP CODES
    ============================================================ */
    match /otp_codes/{email} {
      allow create: if isServiceAccount()
                    && isValidEmail(email)
                    && request.resource.data.keys().hasOnly(['code','timestamp'])
                    && request.resource.data.timestamp is number;

      allow read: if isAuthenticated()
                  && request.auth.token.email == email;

      allow delete: if isServiceAccount();

      allow update: if false;
    }


    /* ============================================================
       ðŸ”¹ OFFICERS (Admin-only Write, Read for all logged users)
    ============================================================ */
    match /officers/{officerId} {

      allow read: if isAuthenticated();

      // Admin full control
      allow create, update, delete: if isAdmin();

      // Service account â€“ LIMITED FIELDS ONLY
      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasOnly([
              'agid','name','mobile','landline','rank','station','district','email','photoUrl'
            ]);
    }


    /* ============================================================
       ðŸ”¹ EMPLOYEES
    ============================================================ */
    match /employees/{employeeId} {

      allow read: if isAuthenticated();

      /* --- Employee can update only their own profile --- */
      // Employees can only update their own profile (matched by firebaseUid or email)
      // They cannot modify protected fields: email, kgid, isAdmin, isApproved, pin, firebaseUid, createdAt, updatedAt
      allow update: if isAuthenticated()
            && (
                // Match by firebaseUid (primary method - works for anonymous and Google Sign-In)
                (resource.data.firebaseUid != null && request.auth.uid == resource.data.firebaseUid)
                ||
                // Match by email fallback (for Google Sign-In users with email in token)
                (hasAuthEmail() && resource.data.email != null && request.auth.token.email == resource.data.email)
            )
            // Ensure document ID (kgid) matches the kgid field in the document for consistency
            && (resource.data.kgid == null || employeeId == resource.data.kgid)
            // Prevent changing protected/sensitive fields - employees can only update: name, mobile, rank, station, district, bloodGroup, photoUrl, etc.
            && !request.resource.data.diff(resource.data).affectedKeys()
                  .hasAny(['email','kgid','isAdmin','isApproved','pin','firebaseUid','createdAt','updatedAt']);


      /* --- Allow setting firebaseUid FIRST TIME ONLY --- */
      allow update: if isAuthenticated()
            && (resource.data.firebaseUid == null || resource.data.firebaseUid == "")
            && request.resource.data.keys().hasOnly(['firebaseUid'])
            && request.resource.data.firebaseUid == request.auth.uid;
            // Note: When only updating firebaseUid, email is not in request.resource.data
            // Security: User must be authenticated and firebaseUid must match their UID


      /* --- Service Account: ONLY photoUrl --- */
      allow update: if isServiceAccount()
            && request.resource.data.keys().hasOnly(['photoUrl'])
            && request.resource.data.photoUrl is string;


      /* --- Admins can do everything --- */
      allow create, update, delete: if isAdmin();
    }


    /* ============================================================
       ðŸ”¹ ADMINS
       Supports both email and UID as document ID
    ============================================================ */
    match /admins/{adminId} {

      allow get, list: if isAdmin();

      // Create admin document (can use email or UID as document ID)
      allow create: if isAdmin()
              && request.resource.data.size() > 0
              && (
                  // If using email as ID, validate it's a valid email
                  (isValidEmail(adminId) && request.resource.data.keys().hasOnly(['email','isActive','uid','updatedAt']))
                  ||
                  // If using UID as ID, allow it
                  (request.resource.data.keys().hasOnly(['email','isActive','uid','updatedAt']))
              )
              && request.resource.data.isActive == true;

      // Update/delete admin document (prevent self-deletion)
      allow update: if isAdmin()
              && request.resource.data.size() > 0
              && (
                  // If adminId is email, prevent self-deletion
                  (isValidEmail(adminId) && adminId != request.auth.token.email)
                  ||
                  // If adminId is UID, prevent self-deletion
                  (adminId != request.auth.uid)
              );
      
      allow delete: if isAdmin()
              && (
                  // If adminId is email, prevent self-deletion
                  (isValidEmail(adminId) && adminId != request.auth.token.email)
                  ||
                  // If adminId is UID, prevent self-deletion
                  (adminId != request.auth.uid)
              );
    }


    /* ============================================================
       ðŸ”¹ META (Admin write)
    ============================================================ */
    match /meta/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }


    /* ============================================================
       ðŸ”¹ PENDING REGISTRATIONS
    ============================================================ */
    match /pending_registrations/{docId} {

      allow create: if request.resource.data.keys().hasAll([
          'kgid','email','name','mobile1','rank','district','station','pin'
      ]) && isValidEmail(request.resource.data.email);

      allow read, update, delete: if isAdmin();
    }


    /* ============================================================
       ðŸ”¹ ADMIN NOTIFICATIONS
    ============================================================ */
    match /admin_notifications/{docId} {
      allow create: if isAdmin() || isServiceAccount();
      allow read, update, delete: if isAdmin();
    }


    /* ============================================================
       ðŸ”¹ NOTIFICATION QUEUE
    ============================================================ */
    match /notifications_queue/{docId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAdmin() || isServiceAccount();
    }


    /* ============================================================
       ðŸ”¹ USEFUL LINKS (Public Read)
    ============================================================ */
    match /useful_links/{linkId} {

      allow read: if true;

      // Admin can create/update/delete with all fields
      allow create, update, delete: if isAdmin();

      // Service account can create/update with required fields
      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasAll(['name'])
            && request.resource.data.name is string
            && request.resource.data.keys().hasOnly(['name','playStoreUrl','apkUrl','iconUrl','createdAt','updatedAt'])
            && (request.resource.data.playStoreUrl == null || request.resource.data.playStoreUrl is string)
            && (request.resource.data.apkUrl == null || request.resource.data.apkUrl is string)
            && (request.resource.data.iconUrl == null || request.resource.data.iconUrl is string)
            && (request.resource.data.createdAt == null || request.resource.data.createdAt is number)
            && (request.resource.data.updatedAt == null || request.resource.data.updatedAt is number);
    }


    /* ============================================================
       ðŸ”¹ GALLERY (Public Read)
    ============================================================ */
    match /gallery/{imageId} {

      allow read: if true;

      allow create, update, delete: if isAdmin();

      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasOnly(['imageUrl']);
    }


    /* ============================================================
       ðŸ”¹ DOCUMENTS
    ============================================================ */
    match /documents/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }


    /* ============================================================
       ðŸ”¹ DISTRICTS (Master Data)
    ============================================================ */
    match /districts/{districtId} {
      // All authenticated users can read districts
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete districts
      allow create, update, delete: if isAdmin();
      
      // Service account can create/update with required fields
      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasAll(['name'])
            && request.resource.data.name is string
            && request.resource.data.keys().hasOnly(['name','range','isActive','createdAt','updatedAt'])
            && (request.resource.data.range == null || request.resource.data.range is string)
            && (request.resource.data.isActive == null || request.resource.data.isActive is bool)
            && (request.resource.data.createdAt == null || request.resource.data.createdAt is timestamp)
            && (request.resource.data.updatedAt == null || request.resource.data.updatedAt is timestamp);
    }


    /* ============================================================
       ðŸ”¹ STATIONS (Master Data)
    ============================================================ */
    match /stations/{stationId} {
      // All authenticated users can read stations
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete stations
      allow create, update, delete: if isAdmin();
      
      // Service account can create/update with required fields
      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasAll(['name', 'district'])
            && request.resource.data.name is string
            && request.resource.data.district is string
            && request.resource.data.keys().hasOnly(['name','district','stdCode','isActive','createdAt','updatedAt'])
            && (request.resource.data.stdCode == null || request.resource.data.stdCode is string)
            && (request.resource.data.isActive == null || request.resource.data.isActive is bool)
            && (request.resource.data.createdAt == null || request.resource.data.createdAt is timestamp)
            && (request.resource.data.updatedAt == null || request.resource.data.updatedAt is timestamp);
    }


    /* ============================================================
       ðŸ”¹ RANKS (Master Data) - rankMaster collection
    ============================================================ */
    match /rankMaster/{rank_id} {
      // All authenticated users can read ranks
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete ranks
      allow create, update, delete: if isAdmin();
      
      // Service account can create/update with required fields
      allow create, update: if isServiceAccount()
            && request.resource.data.keys().hasAll(['rank_id', 'rank_label', 'staffType', 'category', 'equivalent_rank', 'seniority_order', 'aliases', 'requiresMetalNumber', 'isActive'])
            && request.resource.data.keys().hasOnly(['rank_id', 'rank_label', 'staffType', 'category', 'equivalent_rank', 'seniority_order', 'aliases', 'requiresMetalNumber', 'isActive', 'remarks', 'createdAt', 'updatedAt'])
            && request.resource.data.rank_id is string
            && request.resource.data.rank_id == rank_id  // Document ID must match rank_id field
            && request.resource.data.rank_label is string
            && request.resource.data.staffType is string
            && (request.resource.data.staffType == "POLICE" || request.resource.data.staffType == "MINISTERIAL")
            && request.resource.data.category is string
            && request.resource.data.equivalent_rank is string
            && request.resource.data.seniority_order is int
            && request.resource.data.aliases is list
            && request.resource.data.requiresMetalNumber is bool
            && request.resource.data.isActive is bool
            && (request.resource.data.remarks == null || request.resource.data.remarks is string)
            && (request.resource.data.createdAt == null || request.resource.data.createdAt is timestamp)
            && (request.resource.data.updatedAt == null || request.resource.data.updatedAt is timestamp);
    }

  }
}
